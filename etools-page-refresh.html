<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../etools-dexiejs/etools-dexiejs.html">

<!--
`etools-page-refresh`

A button that will clear your app cache then refresh the page

@demo demo/index.html 
-->

<dom-module id="etools-page-refresh">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
    <paper-icon-button icon="refresh" on-tap="_refresh" disabled="[[refreshInProgress]]"></paper-icon-button>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'etools-page-refresh',

        properties: {

        },

        ready: function() {
          this.dexieDbsNumber = 0;
          this.deleteAttemptsOnDbs = [];
        },

        _refresh: function() {
          this.refreshInProgress = true;
          // clear localStorage data
          this._clearLocalStorage();
          // clear DexieDBs for current host
          this._clearDexieDbs();
        },

        _clearLocalStorage: function() {
          localStorage.clear();
        },

        _clearDexieDbs: function() {
          // except Chrome and Opera this method will delete only the dbs created with Dexie
          Dexie.getDatabaseNames(function(dbsNames) {
            this.dexieDbsNumber = dbsNames.length;
            if (this.dexieDbsNumber > 0) {
              dbsNames.forEach(function(dbName) {
                this._deleteDexieDb(dbName);
              }.bind(this));
            } else {
              // no dexie dbs to delete, just refresh the page
              this._refreshPage();
            }
          }.bind(this));
        },

        _deleteDexieDb: function(dbName) {
          var db = new Dexie(dbName);
          db.delete().catch(function (err) {
            console.error("Could not delete indexedDB: " + dbName, err);
          }).finally(function() {
            this.push('deleteAttemptsOnDbs', dbName);
            this._dexieDbsDeleted();
          }.bind(this));
        },

        _dexieDbsDeleted: function() {
          if (this.dexieDbsNumber > 0 && this.deleteAttemptsOnDbs.length === this.dexieDbsNumber) {
            this._refreshPage();
          }
        },

        _refreshPage: function() {
          this.refreshInProgress = false;
          window.location.reload(true);
        }

      });
    })();
  </script>
</dom-module>
