<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../etools-dexiejs/etools-dexiejs.html">

<!--
`etools-page-refresh`

A button that will clear your app cache then refresh the page

@demo demo/index.html 
-->

<dom-module id="etools-page-refresh">
  <template>
    <style>
      :host {
        display: inline-block;
      }
    </style>
    <paper-icon-button icon="refresh" on-tap="_refresh" disabled="[[refreshInProgress]]"></paper-icon-button>
  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'etools-page-refresh',

        properties: {
          config: {
            type: Object,
            value: {
              localStorage: true,
              dexieDbs: []
            }
          }
        },

        ready: function() {
          this.deleteAttemptsOnDbs = [];

          // prevent use of invalid config objects
          if (typeof this.config.localStorage === 'undefined') {
            this.config.localStorage = true;
          }
          if (typeof this.config.dexieDbs === 'undefined' || !Array.isArray(this.config.dexieDbs)) {
            this.config.dexieDbs = [];
          }
        },

        _refresh: function() {
          this.refreshInProgress = true;
          // clear localstorage
          if (this.config.localStorage) {
            this._clearLocalStorage();
          }

          // clear indexed dbs
          if (this.config.dexieDbs.length > 0) {
            this._clearDexieDbs(this.config.dexieDbs);
          } else {
            this._refreshPage();
          }
        },

        _clearLocalStorage: function() {
          localStorage.clear();
        },

        _clearDexieDbs: function(dexieDbs) {
          dexieDbs.forEach(function(dbName) {
            this._deleteDexieDb(dbName);
          }.bind(this));
        },

        _deleteDexieDb: function(dbName) {
          var db = new Dexie(dbName);
          db.delete().catch(function (err) {
            console.error("Could not delete indexedDB: " + dbName, err);
          }).finally(function() {
            this.push('deleteAttemptsOnDbs', dbName);
            this._dexieDbsDeleted(this.deleteAttemptsOnDbs);
          }.bind(this));
        },

        _dexieDbsDeleted: function(deletedDexieDbs) {
          if (deletedDexieDbs.length > 0 && deletedDexieDbs.length === this.config.dexieDbs.length) {
            this._refreshPage();
          }
        },

        _refreshPage: function() {
          this.refreshInProgress = false;
          window.location.reload(true);
        }

      });
    })();
  </script>
</dom-module>
